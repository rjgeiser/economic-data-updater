name: Run Policy Tracker

on:
  schedule:
    - cron: "0 18 * * *"   # daily 18:00 UTC (1pm ET during Standard Time)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run-policy-tracker:
    runs-on: ubuntu-latest
    env:
      # Tweak these as needed; safe defaults provided by the script if unset.
      START_DATE: "2025-10-01"
      END_DATE: "2025-11-11"
      FR_TYPES: "PRORULE"          # e.g. "PRORULE,NOTICE"
      CHUNK_DAYS: "7"
      REQUEST_TIMEOUT: "20"
      MAX_RETRIES: "5"
      DATA_OUT: "docs/data/Policy_Events.json"

      # Optional: provide both to enable Google Sheets sync
      GOOGLE_CREDENTIALS: ${{ secrets.GOOGLE_CREDENTIALS }}
      GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.9"

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install requests gspread google-auth

      - name: Run policy tracker
        run: python policy_tracker.py

      - name: Commit JSON
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add docs/data/Policy_Events.json
          git diff --staged --quiet || git commit -m "chore(policy): update Policy_Events.json"

      - name: Push changes
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ensure remote uses token (checkout usually sets this already)
          git remote set-url origin "https://x-access-token:${GITHUB_TOKEN}@github.com/${{ github.repository }}.git"
          git push origin HEAD:${{ github.ref_name }}
